# dip_yakalama_daily_120dip_rebound.py
import warnings
warnings.filterwarnings("ignore")

import os
import json
import time
import random
import requests
from datetime import datetime

import yfinance as yf
import pandas as pd
import numpy as np


# ============================================================
# TELEGRAM (GitHub Secrets / ENV)
# ============================================================
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN", "").strip()
TELEGRAM_CHAT_ID   = os.getenv("TELEGRAM_CHAT_ID", "").strip()
TELEGRAM_TIMEOUT   = 20

STATE_FILE = "last_top5_state.json"
OUT_XLSX   = "dip_yakalama_daily_120dip_rebound_sonuclar.xlsx"
SKIP_XLSX  = "scan_skipped.xlsx"


def telegram_send(text: str) -> bool:
    if not TELEGRAM_BOT_TOKEN or not TELEGRAM_CHAT_ID:
        print("âš ï¸ Telegram ENV eksik")
        return False

    url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
    payload = {
        "chat_id": TELEGRAM_CHAT_ID,
        "text": text,
        "disable_web_page_preview": True,
    }
    try:
        r = requests.post(url, json=payload, timeout=TELEGRAM_TIMEOUT)
        return r.status_code == 200
    except Exception as e:
        print(f"Telegram error: {e}")
        return False


# ============================================================
# SEMBOLLER (ARTIK KODUN Ä°Ã‡Ä°NDE)
# ============================================================
SYMBOLS = [
    "NVDA",
"GOOGL",
"GOOG",
"AAPL",
"MSFT",
"AMZN",
"TSM",
"META",
"AVGO",
"TSLA",
"BRK-A",
"BRK-B",
"JPM",
"LLY",
"WMT",
"V",
"XOM",
"ASML",
"JNJ",
"ORCL",
"BAC",
"MA",
"MU",
"COST",
"BABA",
"AMD",
"PLTR",
"ABBV",
"HD",
"NFLX",
"GS",
"PG",
"CVX",
"JPM-PD",
"JPM-PC",
"UNH",
"MS",
"KO",
"BAC-PK",
"GE",
"BAC-PL",
"CSCO",
"CAT",
"TM",
"AZN",
"HSBC",
"C",
"NVS",
"NVO",
"LRCX",
"SAP",
"IBM",
"WFC",
"BML-PG",
"BML-PH",
"PM",
"MRK",
"BAC-PE",
"BML-PL",
"RTX",
"AMAT",
"BAC-PB",
"BML-PJ",
"AXP",
"RY",
"TMO",
"MCD",
"CRM",
"LIN",
"INTC",
"TMUS",
"SHEL",
"MUFG",
"KLAC",
"WFC-PY",
"PEP",
"DIS",
"BA",
"WFC-PL",
"APH",
"ISRG",
"ABT",
"AMGN",
"SAN",
"SCHW",
"BX",
"GEV",
"APP",
"ANET",
"RIO",
"TXN",
"NEE",
"SHOP",
"TD",
"BHP",
"ACN",
"BLK",
"UBER",
"GILD",
"DHR",
"T",
"VZ",
"TJX",
"BKNG",
"QCOM",
"HDB",
"SPGI",
"INTU",
"LOW",
"SCCO",
"UBS",
"PDD",
"TTE",
"HON",
"ADI",
"PFE",
"UL",
"BBVA",
"NOW",
"DE",
"COF",
"BSX",
"NEM",
"SONY",
"UNP",
"SYK",
"LMT",
"SMFG",
"BUD",
"ETN",
"MDT",
"PANW",
"IBKR",
"BTI",
"ADBE",
"WELL",
"WFC-PC",
"COP",
"VRTX",
"PGR",
"ARM",
"CB",
"PH",
"CRWD",
"PLD",
"CMCSA",
"SNY",
"MELI",
"BMY",
"HCA",
"KKR",
"SBUX",
"AEM",
"CVS",
"MO",
"BN",
"SPOT",
"MFG",
"ADP",
"ENB",
"IBN",
"CEG",
"MCK",
"CVNA",
"LYG",
"CME",
"GSK",
"ICE",
"GD",
"SO",
"SNPS",
"HOOD",
"NKE",
"NOC",
"BP",
"MCO",
"WM",
"BNS",
"ITUB",
"PBR",
"DUK",
"BCS",
"UPS",
"MRSH",
"DASH",
"PBR-A",
"PNC",
"NU",
"BMO",
"FCX",
"CDNS",
"TT",
"B",
"SHW",
"USB",
"HWM",
"MAR",
"NTES",
"ELV",
"ORLY",
"MMM",
"ING",
"MS-PK",
"AMT",
"EMR",
"BK",
"WDC",
"BAM",
"MS-PI",
"NGG",
"CRH",
"ABNB",
"GLW",
"TDG",
"REGN",
"DB",
"MS-PF",
"ECL",
"RCL",
"MS-PE",
"MNST",
"EQIX",
"CMI",
"WMB",
"USB-PH",
"STX",
"CTAS",
"DELL",
"APO",
"MDLZ",
"GM",
"ITW",
"GS-PA",
"CNQ",
"INFY",
"CI",
"SE",
"SLB",
"USB-PP",
"AON",
"SNOW",
"GS-PD",
"FDX",
"RELX",
"EPD",
"NWG",
"MRVL",
"JCI",
"MS-PA",
"PWR",
"WBD",
"SPG",
"HLT",
"CSX",
"VRT",
"COR",
"SNDK",
"CL",
"RSG",
"WPM",
"VALE",
"MSI",
"CP",
"TEL",
"NET",
"LHX",
"AJG",
"KMI",
"NSC",
"TFC",
"PCAR",
"EQNR",
"FTNT",
"AEP",
"AZO",
"TRV",
"CNI",
"MFC",
"AMX",
"SU",
"DUK-PA",
"ET",
"ROST",
"RACE",
"RKT",
"E",
"CTA-PB",
"EOG",
"TRP",
"URI",
"APD",
"AFL",
"NXPI",
"BDX",
"ADSK",
"COIN",
"VLO",
"NDAQ",
"PSX",
"SRE",
"DLR",
"IDXX",
"MPLX",
"TRI",
"BKR",
"O",
"TAK",
"ZTS",
"AU",
"BIDU",
"PYPL",
"VST",
"F",
"CMG",
"CCJ",
"MPC",
"RBLX",
"IMO",
"ALL",
"ARGX",
"D",
"MET",
"MPWR",
"EA",
"SCHW-PD",
"FERG",
"WDAY",
"AME",
"BSBR",
"CBRE",
"GWW",
"FAST",
"FNV",
"CAH",
"DEO",
"EW",
"CTVA",
"GFI",
"ARES",
"CRWV",
"PSA",
"CARR",
"OKE",
"FER",
"AXON",
"DDOG",
"ALNY",
"ROK",
"TGT",
"AMP",
"CTA-PA",
"HEI",
"MSTR",
"KGC",
"HLN",
"MSCI",
"TTWO",
"LNG",
"SPG-PJ",
"EXC",
"XEL",
"FANG",
"DAL",
"WCN",
"ROP",
"ABEV",
"JD",
"DHI",
"OXY",
"ASX",
"EBAY",
"MET-PE",
"RKLB",
"YUM",
"ETR",
"KR",
"BBD",
"MET-PA",
"EL",
"CTSH",
"TCOM",
"LVS",
"TRGP",
"AIG",
"CCEP",
"CM",
"MT",
"IQV",
"NUE",
"PUK",
"RDDT",
"MCHP",
"CPRT",
"XYZ",
"HEI-A",
"ALC",
"GRMN",
"FIX",
"VMC",
"WAB",
"PEG",
"MLM",
"NOK",
"HMC",
"HSY",
"ASTS",
"A",
"BBDO",
"PRU",
"PSA-PH",
"PAYX",
"CCI",
"ED",
"CUK",
"KDP",
"CCL",
"ONC",
"MDLN",
"RMD",
"FICO",
"FMX",
"TEVA",
"TER",
"VEEV",
"KEYS",
"GEHC",
"ODFL",
"FISV",
"HIG",
"TEAM",
"ERIC",
"SYY",
"RYAAY",
"VTR",
"CPNG",
"CVE",
"WEC",
"STT",
"OTIS",
"CLS",
"SYM",
"SLF",
"EQT",
"APO-PA",
"ACGL",
"XYL",
"UAL",
"IR",
"SATS",
"LYV",
"ZS",
"NTR",
"KB",
"INSM",
"KVUE",
"NTRA",
"KMB",
"RJF",
"MTB",
"IX",
"MDB",
"PCG",
"FITB",
"EXPE",
"VOD",
"CHT",
"UI",
"DG",
"WDS",
"BE",
"ESLT",
"PSA-PK",
"ALL-PH",
"CIEN",
"SOFI",
"ADM",
"ALL-PB",
"FOXA",
"HUM",
"EME",
"WTW",
"COHR",
"EXR",
"VIK",
"FIS",
"FOX",
"VRSK",
"QSR",
"FLUT",
"VICI",
"ROL",
"AMRZ",
"ULTA",
"FTAI",
"BNTX",
"MTD",
"TSCO",
"HAL",
"NRG",
"SYF",
"DXCM",
"LPLA",
"ZM",
"UMC",
"TDY",
"HPE",
"TME",
"DOV",
"NTRS",
"CBOE",
"DTE",
"STZ",
"STLA",
"AEE",
"KHC",
"SHG",
"CSGP",
"PHG",
"IRM",
"BAP",
"ALAB",
"CQP",
"PAAS",
"WIT",
"LEN",
"HBAN",
"ATO",
"EC",
"BRO",
"FE",
"PPL",
"KEP",
"CFG",
"TECK",
"EXE",
"FTS",
"NMR",
"CHTR",
"LEN-B",
"EFX",
"ES",
"TPR",
"FSLR",
"STE",
"HUBB",
"JBL",
"CNP",
"MKL",
"AER",
"DLTR",
"AWK",
"STLD",
"OMC",
"PPG",
"STM",
"WRB",
"BIIB",
"AVB",
"VLTO",
"ON",
"DLR-PK",
"CINF",
"FCNCA",
"PHM",
"GFS",
"DVN",
"RGLD",
"CW",
"EQR",
"WSM",
"BR",
"RF",
"LDOS",
"PSTG",
"SQM",
"FLEX",
"GIS",
"AXIA-P",
"EIX",
"RPRX",
"PBA",
"LITE",
"TPL",
"AXIA-PC",
"ILMN",
"VRSN",
"KEY",
"BCE",
"TPG",
"TROW",
"WAT",
"TW",
"CRDO",
"NBIS",
"VG",
"AXIA",
"CPAY",
"CASY",
"LULU",
"DRI",
"OWL",
"CNC",
"IP",
"FUTU",
"AFRM",
"SW",
"DLR-PJ",
"TLK",
"CYBR",
"TSN",
"FTI",
"FWONK",
"CHD",
"VIV",
"ALB",
"BCH",
"PSLV",
"FWONA",
"KOF",
"LH",
"TS",
"CG",
"LUV",
"BG",
"RL",
"RBA",
"CMS",
"CIB",
"EXPD",
"TU",
"UTHR",
"L",
"NVR",
"GPN",
"CHRW",
"AS",
"BEKE",
"SSNC",
"CTRA",
"NI",
"GMAB",
"PFG",
"AMCR",
"TWLO",
"IHG",
"DGX",
"Q",
"INCY",
"HL",
"DOW",
"SBAC",
"PKG",
"WWD",
"RCI",
"CHKP",
"PTC",
"LTM",
"NTAP",
"TOST",
"JBHT",
"EXAS",
"SGI",
"GIB",
"GPC",
"MTZ",
"RIVN",
"SNA",
"WY",
"PODD",
"TYL",
"IFF",
"RVMD",
"PKX",
"BWXT",
"KTOS",
"MRNA",
"HIG-PG",
"GRAB",
"SBS",
"IOT",
"FTV",
"DD",
"CX",
"BURL",
"PHYS",
"U",
"SMCI",
"DKS",
"APG",
"BEP",
"HPQ",
"STT-PG",
"USFD",
"CRCL",
"LII",
"FITBI",
"XPEV",
"IT",
"PSNYW",
"AGI",
"NVT",
"ALLY",
"KEY-PK",
"PNR",
"EVRG",
"PINS",
"ENTG",
"XPO",
"ESS",
"SN",
"CRS",
"WST",
"HUBS",
"ZBH",
"NWS",
"LNT",
"JBS",
"YUMC",
"IREN",
"RS",
"LI",
"ZG",
"BSAC",
"ATI",
"ZTO",
"FN",
"TRMB",
"MEDP",
"JLL",
"QXO",
"TXT",
"Z",
"HOLX",
"THC",
"APTV",
"TKO",
"CDW",
"RTO",
"WES",
"TRU",
"TTD",
"INVH",
"MTSI",
"LYB",
"MKC",
"CDE",
"NLY",
"BIP",
"NXT",
"J",
"MKC-V",
"HII",
"MAA",
"OKTA",
"COO",
"SUI",
"TLN",
"GFL",
"RBC",
"WMG",
"KSPI",
"ITT",
"ROKU",
"ROIV",
"GEN",
"NWSA",
"WSO",
"EWBC",
"BALL",
"FFIV",
"YPF",
"H",
"HTHT",
"IONQ",
"ONON",
"CRBG",
"WSO-B",
"DKNG",
"VTRS",
"WF",
"AA",
"NDSN",
"AVAV",
"MGA",
"KEY-PI",
"WPC",
"DECK",
"EMA",
"CSL",
"BBIO",
"GH",
"FNF",
"MLI",
"CF",
"KEY-PJ",
"HMY",
"PFGC",
"IEX",
"ULS",
"MKSI",
"GDDY",
"ERIE",
"ARCC",
"ICLR",
"SNN",
"AVY",
"FIG",
"RGC",
"PNFP",
"KRMN",
"GGG",
"ALLE",
"MAS",
"RF-PC",
"W",
"TSEM",
"ASND",
"LECO",
"PAC",
"CACI",
"AKAM",
"JHX",
"KIM",
"PEN",
"EVR",
"CELH",
"DPZ",
"BBY",
"EMBJ",
"CLH",
"WCC",
"UDR",
"SBSW",
"TOL",
"LOGI",
"EQH",
"RPM",
"CLX",
"GWRE",
"EG",
"SOLV",
"NVMI",
"BILI",
"RBRK",
"CNH",
"HRL",
"FIGR",
"PAA",
"NLY-PG",
"BLD",
"NLY-PF",
"AMH",
"NBIX",
"OHI",
"BEN",
"RVTY",
"JKHY",
"RYAN",
"BLDR",
"SF",
"RGA",
"IONS",
"PSKY",
"UHS",
"REG",
"HST",
"CHWY",
"LAMR",
"UNM",
"SNAP",
"JEF",
"RNR",
"FMS",
"VNOM",
"BNT",
"BJ",
"OKLO",
"HLI",
"BF-A",
"GLPI",
"EQX",
"IVZ",
"ELS",
"ACM",
"CNA",
"BF-B",
"SWK",
"AGNC",
"BMNR",
"GLXY",
"AG",
"GMED",
"HAS",
"SNX",
"AMKR",
"IAG",
"DT",
"ACGLO",
"ZBRA",
"DTM",
"TXRH",
"DOC",
"SMMT",
"RMBS",
"EPAM",
"ELAN",
"GIL",
"ALGN",
"CCK",
"JOBY",
"SUZ",
"CR",
"CMA",
"TEM",
"WMS",
"FHN",
"WYNN",
"NYT",
"AEG",
"AIZ",
"MAA-PI",
"EXEL",
"NTNX",
"BSY",
"NIO",
"DCI",
"RDY",
"DOCU",
"CPT",
"BXP",
"LSCC",
"STN",
"CEF",
"MDGL",
"BAH",
"SCI",
"MICC",
"CNM",
"MP",
"DY",
"GL",
"TIMB",
"QGEN",
"WTRG",
"PNW",
"DAY",
"STRL",
"SJM",
"PR",
"SARO",
"RNA",
"CRL",
"AR",
"UHAL",
"BMRN",
"MOH",
"SUN",
"CFLT",
"DRS",
"WLK",
"GME",
"SPXC",
"MANH",
"FDS",
"AFG",
"CART",
"AIT",
"PAG",
"SEIC",
"TECH",
"CAE",
"OVV",
"WBS",
"YMM",
"AES",
"FIVE",
"XP",
"BWA",
"ENSG",
"ASR",
"ONTO",
"OC",
"TIGO",
"PCOR",
"KLAR",
"ARMK",
"BPYPP",
"FLS",
"RRX",
"APLD",
"JAZZ",
"BAX",
"PPC",
"SSB",
"HBM",
"CHYM",
"VNO-PL",
"UHAL-B",
"SAIL",
"SANM",
"WTS",
"AOS",
"BVN",
"COKE",
"NGD",
"POOL",
"AEIS",
"GAP",
"VNO-PM",
"MOG-B",
"COMP",
"WTFC",
"GNRC",
"BIO-B",
"OSK",
"EHC",
"TTMI",
"ALV",
"SOLS",
"WAL",
"ARE",
"EGO",
"TAP",
"DDS",
"BROS",
"MOG-A",
"REXR",
"AAL",
"KT",
"ORI",
"TTEK",
"AYI",
"SKM",
"ABVX",
"EGP",
"NCLH",
"ACI",
"HSIC",
"KNSL",
"IESC",
"MGM",
"UWMC",
"GTLS",
"ARWR",
"UMBF",
"AXSM",
"GS-PC",
"EDU",
"SFD",
"ONB",
"DINO",
"SAIA",
"RGEN",
"DOX",
"ALSN",
"KNX",
"STEP",
"LINE",
"APA",
"SITM",
"MOS",
"SWKS",
"AM",
"TFII",
"OGE",
"MORN",
"GDS",
"AMG",
"UEC",
"LUMN",
"GGAL",
"QBTS",
"TTAN",
"RZB",
"FRT",
"AGNCM",
"VMI",
"CFR",
"AGNCN",
"RRC",
"TTC",
"ZION",
"LKQ",
"PEGA",
"CAG",
"COLB",
"CUBE",
"AHR",
"VIPS",
"OR",
"AUR",
"GGB",
"UGI",
"IDCC",
"AMTM",
"PL",
"AGCO",
"CMC",
"LEVI",
"ADC",
]

# duplicate temizliÄŸi (garanti olsun)
SYMBOLS = list(dict.fromkeys([s.upper() for s in SYMBOLS]))


# ============================================================
# AYARLAR
# ============================================================
DAILY_PERIOD = "2y"
DIP_WINDOW_DAILY = 120

MIN_REBOUND_PCT = 3.0
REQUIRE_CLOSE_ABOVE_EMA20 = True
SLOPE_BARS = 5

MAX_RETRIES = 4
TIMEOUT_SEC = 30
BASE_SLEEP = 1.0

THROTTLE_MIN = 0.15
THROTTLE_MAX = 0.45


# ============================================================
# YARDIMCI
# ============================================================
def _flatten_columns(df: pd.DataFrame) -> pd.DataFrame:
    if isinstance(df.columns, pd.MultiIndex):
        df.columns = [c[0] if isinstance(c, tuple) else c for c in df.columns]
    df.columns = [str(c).strip() for c in df.columns]
    return df


def fetch_daily(symbol: str) -> pd.DataFrame | None:
    last_err = None
    for attempt in range(1, MAX_RETRIES + 1):
        try:
            df = yf.download(
                symbol,
                period=DAILY_PERIOD,
                interval="1d",
                auto_adjust=False,
                progress=False,
                group_by="column",
                threads=False,
                timeout=TIMEOUT_SEC,
            )
            if df is None or df.empty:
                return None

            df = _flatten_columns(df)

            if "Close" not in df.columns and "Adj Close" in df.columns:
                df["Close"] = df["Adj Close"]
            if "Close" not in df.columns:
                return None

            for col in ["Open", "High", "Low", "Volume"]:
                if col not in df.columns:
                    df[col] = np.nan

            df = df[["Open","High","Low","Close","Volume"]].dropna(subset=["Close"])

            if len(df) < DIP_WINDOW_DAILY + 10:
                return None

            return df

        except Exception as e:
            last_err = e
            time.sleep(BASE_SLEEP * (2 ** (attempt - 1)) + random.uniform(0, 0.6))

    print(f"âŒ {symbol} veri alÄ±namadÄ± | {last_err}")
    return None


def scan_daily(symbol: str) -> dict | None:
    df = fetch_daily(symbol)
    if df is None:
        return None

    close = df["Close"].astype(float)
    win = close.iloc[-DIP_WINDOW_DAILY:]

    dip_idx = win.idxmin()
    dip_price = close.loc[dip_idx]
    last_price = close.iloc[-1]

    rebound_pct = (last_price / dip_price - 1) * 100
    if rebound_pct < MIN_REBOUND_PCT:
        return None

    ema20 = close.ewm(span=20, adjust=False).mean()
    if REQUIRE_CLOSE_ABOVE_EMA20 and last_price < ema20.iloc[-1]:
        return None

    slope = ema20.iloc[-1] - ema20.iloc[-SLOPE_BARS]

    return {
        "Sembol": symbol,
        "Dip_Tarih": dip_idx.strftime("%Y-%m-%d"),
        "Dip_Fiyat": round(float(dip_price), 2),
        "Son_KapanÄ±ÅŸ": round(float(last_price), 2),
        "Dipten_Sonra_%": round(float(rebound_pct), 2),
        "EMA20_Slope": round(float(slope), 5),
    }


# ============================================================
# STATE
# ============================================================
def load_state():
    if os.path.exists(STATE_FILE):
        with open(STATE_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    return {}


def save_state(state: dict):
    with open(STATE_FILE, "w", encoding="utf-8") as f:
        json.dump(state, f, ensure_ascii=False, indent=2)


# ============================================================
# MAIN (GitHub Actions tek run)
# ============================================================
def main():
    rows = []
    skipped = []

    print(f"ðŸ“Œ Run: {datetime.now()} | Sembol: {len(SYMBOLS)}")

    for i, sym in enumerate(SYMBOLS, 1):
        res = scan_daily(sym)
        if res:
            rows.append(res)
            print(f"âœ… {sym} | Dip: {res['Dip_Tarih']} | %{res['Dipten_Sonra_%']}")
        else:
            skipped.append(sym)
            print(f"â­ï¸ {sym}")
        time.sleep(random.uniform(THROTTLE_MIN, THROTTLE_MAX))

    # Veri yoksa â†’ Cuma verisini bozma
    if not rows:
        print("âš ï¸ SonuÃ§ yok â†’ Excel ve state gÃ¼ncellenmedi")
        return

    df = pd.DataFrame(rows)
    df["__dip"] = pd.to_datetime(df["Dip_Tarih"])
    df = df.sort_values("__dip", ascending=False).drop(columns="__dip")

    df.to_excel(OUT_XLSX, index=False)
    pd.DataFrame(skipped, columns=["Sembol"]).to_excel(SKIP_XLSX, index=False)

    top5 = df.head(5)[["Sembol","Dip_Tarih","Dipten_Sonra_%","Son_KapanÄ±ÅŸ"]]
    top5_list = top5.to_dict(orient="records")

    state = load_state()
    prev_top5 = state.get("top5", [])

    if top5_list != prev_top5:
        msg = ["ðŸ“Œ DÄ°P YAPMIÅž Ä°LK 5 hisse", ""]
        for i, r in enumerate(top5_list, 1):
            msg.append(
                f"{i}) {r['Sembol']} | Dip: {r['Dip_Tarih']} | %{r['Dipten_Sonra_%']} | Son: {r['Son_KapanÄ±ÅŸ']}"
            )
        telegram_send("\n".join(msg))
        print("âœ… Telegram gÃ¶nderildi")
    else:
        print("â„¹ï¸ Top5 deÄŸiÅŸmedi â†’ mesaj yok")

    state["top5"] = top5_list
    state["last_run"] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    save_state(state)


if __name__ == "__main__":
    main()
